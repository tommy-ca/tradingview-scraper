# Design: TradingView Screener Feature Fetching (v1)

**Phase**: 820
**Status**: Active
**Target**: `tradingview_scraper/futures_universe_selector.py`, `tradingview_scraper/pipelines/selection/stages/feature_engineering.py`

## 1. Objective
To leverage the TradingView Screener API's extensive technical indicator catalog to reduce local computation overhead during the Alpha cycle, while ensuring local fallback parity.

## 2. Feature Mapping

The following mapping defines the relationship between internal feature names and TradingView Screener API fields.

| Internal Name | TV Screener Field | Category |
| :--- | :--- | :--- |
| `recommend_all` | `Recommend.All` | Rating |
| `recommend_ma` | `Recommend.MA` | Rating |
| `recommend_other` | `Recommend.Other` | Rating |
| `adx` | `ADX` | Trend |
| `rsi` | `RSI` | Momentum |
| `macd` | `MACD.macd` | Momentum |
| `macd_signal` | `MACD.signal` | Momentum |
| `mom` | `Mom` | Momentum |
| `ao` | `AO` | Momentum |
| `stoch_k` | `Stoch.K` | Momentum |
| `stoch_d` | `Stoch.D` | Momentum |
| `cci` | `CCI20` | Momentum |
| `willr` | `W.R` | Momentum |
| `uo` | `UO` | Momentum |
| `bb_power` | `BBPower` | Momentum |
| `ichimoku_kijun`| `Ichimoku.BLine` | Trend |
| `volatility_d` | `Volatility.D` | Volatility |
| `atr` | `ATR` | Volatility |

## 3. Implementation Details

### 3.1 Expanded Default Columns
Update `FuturesUniverseSelector.DEFAULT_COLUMNS` to include these fields so they are always retrieved during discovery.

### 3.2 Prioritized Injection (L1 Stage)
Update `FeatureEngineeringStage` to:
1. Check `context.params.get("pit_features")` (Highest priority for Backtest).
2. Check `candidate.metadata` for TV Screener fields (e.g. `Recommend.All`).
3. Fallback to local `TechnicalRatings` calculation.

### 3.3 Numerical Parity
The local `TechnicalRatings` class has been tuned to match TV Screener logic:
- **Ichimoku**: Comparing Price vs Kijun-sen (Base Line).
- **Recommend.All**: Weighted average of MA and Other components.
- **Components**: Standard lengths (10, 20, 30, 50, 100, 200).

### 3.4 Resilience & Rate Limits
- `ingest_features.py` wraps Screener fetches with bounded retries and backoff to survive transient 429/handshake failures.
- Feature ingestion fan-out is limited (Makefile defaults P=2, workers<=3) with per-attempt coverage logs; zero coverage after retries remains a hard failure.
- Persist coverage summaries (attempt counts, successes/failures, failing symbols) in the run dir to support audits and rerun triage.
- Coverage artifacts must be discoverable by audit tooling (ledger link) before promoting run_ids into manifest/meta pipelines.
- Promotion should be blocked if coverage artifacts are missing, malformed, or show <100% coverage (unless an explicit waiver is recorded in the audit ledger).

## 4. Workflow

1.  **Discovery**: `make scan-run` fetches the "Latest" values for all assets.
2.  **Selection (Live)**: If running for "now", use the fetched values.
3.  **Selection (Backtest)**: Use the historical PIT feature store (generated by `backfill_features.py` which uses local calculation).
4.  **Audit**: Log whether features were "Retrieved" or "Computed".

## 5. Success Criteria
- Reduction in CPU time for `FeatureEngineeringStage` during live runs.
- Consistency between `Backtest` results and `Live` metrics for the same point in time.
