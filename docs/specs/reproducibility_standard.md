# Specification: Institutional Reproducibility & Determinism Standard

## 1. Overview
This standard defines the protocols for ensuring that every quantitative portfolio generated by the platform is perfectly reproducible, deterministic, and traceable. It establishes the "Resolved Manifest" as the unit of replayability.

## 2. The 5-Layer Resolution Hierarchy
To determine the final value of any setting, the platform resolves multiple sources in the following priority (highest to lowest):

1.  **L5: Tactical Overrides (CLI)**: Direct flags or JSON strings passed via command line (e.g., `VETOES=1`).
2.  **L4: System Environment**: `TV_` prefixed variables (e.g., `TV_LOOKBACK_DAYS=500`).
3.  **L3: Profile Overrides**: Settings defined in the specific manifest profile (e.g., `profiles.canary`).
4.  **L2: Manifest Defaults**: Institutional baselines defined in the top-level `defaults` block.
5.  **L1: Code Defaults**: Hardcoded fallbacks in the Pydantic models.

## 3. The Resolved Manifest (`resolved_manifest.json`)
Every production run must generate a `resolved_manifest.json` snapshot in its run directory:
- `data/artifacts/summaries/runs/<RUN_ID>/config/resolved_manifest.json`

### 3.1 Content Requirements
- **Final Values**: The exact parameters used for the run after the 5-layer resolution.
- **Execution Context**:
    - `run_id`: The unique identifier for the run.
    - `git_commit`: The SHA-1 hash of the current repository state.
    - `timestamp`: The exact start time of the orchestrator.
- **Input Fingerprints**:
    - SHA-256 hashes of all foundational symbol files (e.g., `sp500_symbols.txt`).
    - Schema version of the manifest.

### 3.2 Path Determinism (No Hard-Coded Paths)
To keep runs replayable across environments:
- All filesystem paths used by pipelines MUST be derived from settings (e.g., `settings.export_dir`, `settings.lakehouse_dir`, `settings.manifest_path`).
- Orchestrators MUST NOT hard-code `configs/manifest.json` when a manifest override is in effect (`TV_MANIFEST_PATH`).
- Scripts MUST resolve run directories via `settings.summaries_runs_dir` (never `artifacts/summaries/runs/...`).

## 4. Replayability Protocol
Replayability is defined as the ability to reconstruct the run **without guessing**:
- Inputs: the original manifest (`TV_MANIFEST_PATH`), the profile (`TV_PROFILE`), and any environment overrides.
- Evidence: `resolved_manifest.json` + `audit.jsonl` provide the effective settings and step-by-step trace.

**Note**: `resolved_manifest.json` is a settings snapshot; it is not required to be a valid multi-profile manifest.

```bash
make flow-production PROFILE=<PROFILE> MANIFEST=<PATH_TO_ORIGINAL_MANIFEST> TV_RUN_ID=<RUN_ID>
```

## 5. Execution Traces (Logs)
To ensure transparency and facilitate debugging of deterministic pipelines, every step of the production sequence must persist its full execution trace.

### 5.1 Log Per-Step Hierarchy
Logs are stored in the `logs/` subdirectory of the run directory:
- `logs/01_cleanup.log`: Trace for environment reset.
- `logs/03_scan-run.log`: Detailed output of TV scanner queries and filters.
- `logs/08_data-fetch.log`: Ingestion progress and rate-limit traces.

### 5.2 Audit Linking
The `audit.jsonl` ledger must contain a `log_file` parameter for every intent record, providing a direct link between a high-level outcome and its low-level execution trace.
